<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago Escrow DApp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        #app {
            max-width: 600px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        input[type="text"],
        input[type="number"],
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        #balance {
            margin: 20px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Pago Escrow DApp</h1>
        <button id="connectButton">Conectar a MetaMask</button>
        <div id="accountInfo"></div>
        <div id="balance"></div>

        <input type="text" id="destinatario" placeholder="Dirección del destinatario">
        <input type="number" id="monto" placeholder="Monto a enviar" min="0.01" step="0.01">
        <button id="realizarPagoButton">Realizar Pago</button>
        <button id="cancelarPagoButton">Cancelar Pago</button>
        <button id="verificarRetencionButton">Verificar Retención</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.6.9/dist/ethers.umd.min.js"></script>
    <script>
        const contractAddress = "0x5A86858aA3b595FD6663c2296741eF4cd8BC4d01"; // Asegúrate de que esta dirección sea correcta
        const contractABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "remitente",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "destinatario",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "monto",
                        "type": "uint256"
                    }
                ],
                "name": "FondosRetenidos",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "remitente",
                        "type": "address"
                    }
                ],
                "name": "PagoCancelado",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "destinatario",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "monto",
                        "type": "uint256"
                    }
                ],
                "name": "PagoLiberado",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "cancelarPago",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "obtenerBalance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_destinatario",
                        "type": "address"
                    }
                ],
                "name": "realizarPagoEscrow",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "verificarRetencion",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let provider;
        let signer;
        let contract;

        async function conectarMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                const account = await signer.getAddress();
                document.getElementById("accountInfo").innerText = `Conectado: ${account}`;
                actualizarBalance();
            } else {
                alert('Por favor, instala MetaMask.');
            }
        }

        async function realizarPago() {
            const destinatario = document.getElementById("destinatario").value;
            const monto = document.getElementById("monto").value;

            if (!destinatario || !monto) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            try {
                const tx = await contract.realizarPagoEscrow(destinatario, { value: ethers.utils.parseEther(monto) });
                await tx.wait();
                alert('Pago realizado con éxito.');
                actualizarBalance();
            } catch (error) {
                console.error(error);
                alert('Error al realizar el pago.');
            }
        }

        async function cancelarPago() {
            try {
                const tx = await contract.cancelarPago();
                await tx.wait();
                alert('Pago cancelado con éxito.');
                actualizarBalance();
            } catch (error) {
                console.error(error);
                alert('Error al cancelar el pago.');
            }
        }

        async function verificarRetencion() {
            try {
                const tx = await contract.verificarRetencion();
                await tx.wait();
                alert('Pago verificado con éxito.');
                actualizarBalance();
            } catch (error) {
                console.error(error);
                alert('Error al verificar la retención.');
            }
        }

        async function actualizarBalance() {
            const balance = await contract.obtenerBalance();
            document.getElementById("balance").innerText = `Balance del contrato: ${ethers.utils.formatEther(balance)} ETH`;
        }

        document.getElementById("connectButton").onclick = conectarMetaMask;
        document.getElementById("realizarPagoButton").onclick = realizarPago;
        document.getElementById("cancelarPagoButton").onclick = cancelarPago;
        document.getElementById("verificarRetencionButton").onclick = verificarRetencion;
    </script>
</body>
</html>
